<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Averías - Google Sheets</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .nav-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 16px 10px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            color: #666;
        }

        .tab.active {
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
            background: white;
        }

        .tab i {
            margin-right: 8px;
        }

        .content {
            padding: 25px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #1a73e8;
            outline: none;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }

        .btn i {
            margin-right: 0;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-success {
            background: #34a853;
        }

        .btn-warning {
            background: #fbbc04;
        }

        .btn-danger {
            background: #ea4335;
        }

        .btn-block {
            width: 100%;
        }

        /* Sistema de filtros */
        .filters-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters-title {
            font-size: 1.2rem;
            color: #1a73e8;
            font-weight: 600;
        }

        .clear-filters {
            background: #ea4335;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .filter-input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .date-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
        }

        .quick-filter-btn {
            background: #e8f0fe;
            color: #1a73e8;
            border: 2px solid #1a73e8;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-filter-btn:hover {
            background: #1a73e8;
            color: white;
        }

        /* Búsqueda principal */
        .search-box {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-box button {
            padding: 0 25px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Resultados */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .results-count {
            font-weight: 700;
            color: #1a73e8;
            font-size: 1.1rem;
        }

        .sort-options {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sort-select {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }

        .data-list {
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .data-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #1a73e8;
            transition: transform 0.3s;
        }

        .data-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .data-matricula {
            background: #1a73e8;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        .data-date {
            color: #666;
            font-size: 0.9rem;
            background: #f0f0f0;
            padding: 5px 12px;
            border-radius: 15px;
        }

        .data-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .data-field {
            display: flex;
            flex-direction: column;
        }

        .data-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .data-value {
            font-weight: 600;
            color: #333;
        }

        .codigo-averia {
            display: inline-block;
            background: #fbbc04;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .data-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #eee;
        }

        .detail-section {
            margin-bottom: 15px;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-section strong {
            color: #1a73e8;
            display: block;
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Configuración */
        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Alertas */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #e8f0fe;
            color: #1a73e8;
            border: 1px solid #c3e6cb;
        }

        /* Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            body {
                padding: 0;
            }
            
            .content {
                padding: 20px;
            }
            
            .tab {
                padding: 12px 5px;
                font-size: 0.9rem;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .date-filters {
                grid-template-columns: 1fr;
            }
            
            .data-content {
                grid-template-columns: 1fr;
            }
            
            .data-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .quick-filters {
                flex-direction: column;
            }
            
            .quick-filter-btn {
                width: 100%;
                justify-content: center;
            }
            
            .filter-actions {
                flex-direction: column;
            }
            
            .filter-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-car-crash"></i> Registro de Averías</h1>
            <p>Sistema de gestión para taller mecánico</p>
        </div>

        <div class="nav-tabs">
            <div class="tab active" data-tab="form">
                <i class="fas fa-plus-circle"></i> Nuevo
            </div>
            <div class="tab" data-tab="search">
                <i class="fas fa-search"></i> Buscar
            </div>
            <div class="tab" data-tab="config">
                <i class="fas fa-cog"></i> Config
            </div>
        </div>

        <div class="content">
            <div class="alert" id="alert"></div>
            
            <div class="spinner" id="spinner"></div>

            <!-- Pestaña: Formulario -->
            <div class="tab-content active" id="form-tab">
                <h2 style="margin-bottom: 20px; color: #1a73e8;">
                    <i class="fas fa-car-crash"></i> Registrar Nueva Avería
                </h2>
                
                <form id="dataForm">
                    <div class="form-group">
                        <label for="fecha"><i class="fas fa-calendar"></i> Fecha</label>
                        <input type="date" id="fecha" name="fecha" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="matricula"><i class="fas fa-car"></i> Matrícula</label>
                        <input type="text" id="matricula" name="matricula" required 
                               placeholder="Ej: 1234ABC" style="text-transform:uppercase">
                    </div>
                    
                    <div class="form-group">
                        <label for="codigo_averia"><i class="fas fa-barcode"></i> Código de Avería</label>
                        <input type="text" id="codigo_averia" name="codigo_averia" 
                               placeholder="Ej: P0301, B1234">
                    </div>
                    
                    <div class="form-group">
                        <label for="marca"><i class="fas fa-industry"></i> Marca</label>
                        <input type="text" id="marca" name="marca" required 
                               placeholder="Ej: Toyota, Volkswagen">
                    </div>
                    
                    <div class="form-group">
                        <label for="modelo"><i class="fas fa-car-side"></i> Modelo</label>
                        <input type="text" id="modelo" name="modelo" required 
                               placeholder="Ej: Corolla 1.6, Golf TDI">
                    </div>
                    
                    <div class="form-group">
                        <label for="sintomas"><i class="fas fa-stethoscope"></i> Síntomas Reportados</label>
                        <textarea id="sintomas" name="sintomas" required 
                                  placeholder="Describe los síntomas que presenta el vehículo..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="averia_real"><i class="fas fa-search"></i> Avería Real Diagnosticada</label>
                        <textarea id="averia_real" name="averia_real" required 
                                  placeholder="Diagnóstico real después de la revisión..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="procedimiento"><i class="fas fa-tools"></i> Procedimiento Realizado</label>
                        <textarea id="procedimiento" name="procedimiento" required 
                                  placeholder="Detalla las reparaciones realizadas..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-block">
                        <i class="fas fa-save"></i> Guardar en Google Sheets
                    </button>
                </form>
            </div>

            <!-- Pestaña: Buscar -->
            <div class="tab-content" id="search-tab">
                <h2 style="margin-bottom: 20px; color: #1a73e8;">
                    <i class="fas fa-search"></i> Buscar Registros
                </h2>
                
                <!-- Sistema de filtros -->
                <div class="filters-container">
                    <div class="filters-header">
                        <div class="filters-title">
                            <i class="fas fa-filter"></i> Filtros de Búsqueda
                        </div>
                        <button class="clear-filters" onclick="clearAllFilters()">
                            <i class="fas fa-times"></i> Limpiar Filtros
                        </button>
                    </div>
                    
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-car"></i> Matrícula
                            </label>
                            <input type="text" id="filterMatricula" class="filter-input" 
                                   placeholder="Ej: 1234ABC">
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-industry"></i> Marca
                            </label>
                            <input type="text" id="filterMarca" class="filter-input" 
                                   placeholder="Ej: Toyota, Volkswagen">
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-barcode"></i> Código Avería
                            </label>
                            <input type="text" id="filterCodigo" class="filter-input" 
                                   placeholder="Ej: P0301">
                        </div>
                    </div>
                    
                    <div class="date-filters">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-calendar"></i> Fecha Desde
                            </label>
                            <input type="date" id="filterFechaDesde" class="filter-input">
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-calendar"></i> Fecha Hasta
                            </label>
                            <input type="date" id="filterFechaHasta" class="filter-input">
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn" id="applyFiltersBtn">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary" id="showAllBtn">
                            <i class="fas fa-list"></i> Ver Todos
                        </button>
                        <button class="btn btn-success" id="exportBtn">
                            <i class="fas fa-file-excel"></i> Exportar
                        </button>
                    </div>
                    
                    <div class="quick-filters">
                        <button class="quick-filter-btn" onclick="filterToday()">
                            <i class="fas fa-calendar-day"></i> Hoy
                        </button>
                        <button class="quick-filter-btn" onclick="filterThisWeek()">
                            <i class="fas fa-calendar-week"></i> Esta Semana
                        </button>
                        <button class="quick-filter-btn" onclick="filterThisMonth()">
                            <i class="fas fa-calendar-alt"></i> Este Mes
                        </button>
                        <button class="quick-filter-btn" onclick="filterByMatriculaPrompt()">
                            <i class="fas fa-car"></i> Por Matrícula
                        </button>
                        <button class="quick-filter-btn" onclick="filterWithCode()">
                            <i class="fas fa-barcode"></i> Con Código
                        </button>
                        <button class="quick-filter-btn" onclick="filterWithoutCode()">
                            <i class="fas fa-times"></i> Sin Código
                        </button>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchInput" 
                           placeholder="Búsqueda general (matrícula, marca, modelo, síntomas, procedimiento...)">
                    <button onclick="searchGeneral()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
                
                <div class="results-header">
                    <div class="results-count" id="resultsCount">0 registros encontrados</div>
                    <div class="sort-options">
                        <label>Ordenar por:</label>
                        <select class="sort-select" id="sortSelect">
                            <option value="date-desc">Fecha (más reciente)</option>
                            <option value="date-asc">Fecha (más antigua)</option>
                            <option value="matricula-asc">Matrícula (A-Z)</option>
                            <option value="matricula-desc">Matrícula (Z-A)</option>
                            <option value="marca-asc">Marca (A-Z)</option>
                        </select>
                    </div>
                </div>
                
                <div class="data-list" id="dataList">
                    <div class="empty-state" id="emptyState">
                        <i class="fas fa-database" style="font-size: 3rem; color: #ddd; display: block; text-align: center; margin: 40px 0 20px;"></i>
                        <h3 style="text-align: center; color: #666;">No hay registros</h3>
                        <p style="text-align: center; color: #888;">Usa los filtros para buscar registros</p>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Configuración -->
            <div class="tab-content" id="config-tab">
                <h2 style="margin-bottom: 20px; color: #1a73e8;">
                    <i class="fas fa-cog"></i> Configuración
                </h2>
                
                <div class="config-section">
                    <h3 style="margin-bottom: 15px;"><i class="fas fa-link"></i> URL de Google Apps Script</h3>
                    <div class="form-group">
                        <label for="scriptUrl">URL de tu aplicación web de Google Apps Script</label>
                        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" onclick="saveConfig()">
                            <i class="fas fa-save"></i> Guardar URL
                        </button>
                        <button class="btn btn-success" onclick="testConnection()">
                            <i class="fas fa-plug"></i> Probar Conexión
                        </button>
                    </div>
                    <div id="connectionStatus" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;">
                        <i class="fas fa-info-circle"></i> <span id="statusText"></span>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3 style="margin-bottom: 15px;"><i class="fas fa-mobile-alt"></i> Instalar como App</h3>
                    <p>Para instalar esta web como una app en tu móvil:</p>
                    <ol style="margin: 15px 0 15px 20px; line-height: 1.6;">
                        <li>Abre esta página en Chrome/Safari</li>
                        <li>Toca el menú (tres puntos o compartir)</li>
                        <li>Selecciona "Añadir a la pantalla de inicio"</li>
                        <li>Sigue las instrucciones para instalarla</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración
        let SCRIPT_URL = localStorage.getItem('taller_script_url') || '';
        let allData = [];
        let filteredData = [];
        
        // Elementos del DOM
        const alertEl = document.getElementById('alert');
        const spinner = document.getElementById('spinner');
        const scriptUrlInput = document.getElementById('scriptUrl');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar fecha actual en formulario
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = today;
            
            // Configurar fechas en filtros
            document.getElementById('filterFechaHasta').value = today;
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            document.getElementById('filterFechaDesde').value = oneMonthAgo.toISOString().split('T')[0];
            
            // Cargar URL guardada
            if (SCRIPT_URL) {
                scriptUrlInput.value = SCRIPT_URL;
                setTimeout(testConnection, 1000);
            } else {
                showAlert('Configura la URL de Google Apps Script en la pestaña Configuración', 'error');
                switchTab('config');
            }
            
            // Configurar tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Configurar formulario
            document.getElementById('dataForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveData();
            });
            
            // Configurar botones de filtros
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('showAllBtn').addEventListener('click', showAllData);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            
            // Configurar ordenación
            document.getElementById('sortSelect').addEventListener('change', sortData);
            
            // Configurar búsqueda con Enter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchGeneral();
                }
            });
        });
        
        // Funciones de navegación
        function switchTab(tabId) {
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                }
            });
            
            if (tabId === 'search' && allData.length === 0) {
                setTimeout(() => {
                    loadAllData();
                }, 300);
            }
        }
        
        // Mostrar alerta
        function showAlert(message, type = 'success') {
            alertEl.textContent = message;
            alertEl.className = `alert alert-${type}`;
            alertEl.style.display = 'block';
            
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 5000);
        }
        
        // Mostrar spinner
        function showSpinner(show) {
            spinner.style.display = show ? 'block' : 'none';
        }
        
        // Guardar configuración
        function saveConfig() {
            const url = scriptUrlInput.value.trim();
            if (!url) {
                showAlert('Por favor, ingresa una URL válida', 'error');
                return;
            }
            
            localStorage.setItem('taller_script_url', url);
            SCRIPT_URL = url;
            showAlert('URL guardada correctamente', 'success');
            testConnection();
        }
        
        // Probar conexión
        async function testConnection() {
            if (!SCRIPT_URL) {
                showAlert('Primero guarda una URL', 'error');
                return;
            }
            
            showSpinner(true);
            
            try {
                const url = `${SCRIPT_URL}?action=test`;
                const response = await fetch(url);
                const result = await response.json();
                
                const statusEl = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                
                if (result.result === 'success') {
                    statusEl.style.display = 'block';
                    statusEl.style.background = '#d4edda';
                    statusEl.style.color = '#155724';
                    statusEl.style.border = '1px solid #c3e6cb';
                    statusText.innerHTML = `✅ Conectado a: <strong>${result.spreadsheet}</strong> (${result.rows} registros)`;
                } else {
                    statusEl.style.display = 'block';
                    statusEl.style.background = '#f8d7da';
                    statusEl.style.color = '#721c24';
                    statusEl.style.border = '1px solid #f5c6cb';
                    statusText.textContent = `❌ Error: ${result.error || 'Sin conexión'}`;
                }
            } catch (error) {
                const statusEl = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                statusEl.style.display = 'block';
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
                statusEl.style.border = '1px solid #f5c6cb';
                statusText.textContent = `❌ Error de conexión: ${error.message}`;
            } finally {
                showSpinner(false);
            }
        }
        
        // Guardar datos
        async function saveData() {
            if (!SCRIPT_URL) {
                showAlert('Configura la URL primero en la pestaña Configuración', 'error');
                switchTab('config');
                return;
            }
            
            const form = document.getElementById('dataForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            if (data.matricula) {
                data.matricula = data.matricula.toUpperCase();
            }
            
            showSpinner(true);
            
            try {
                const url = `${SCRIPT_URL}?action=insert&${new URLSearchParams(data).toString()}`;
                const response = await fetch(url, { method: 'POST' });
                const result = await response.json();
                
                if (result.result === 'success') {
                    showAlert('✅ Registro guardado correctamente', 'success');
                    form.reset();
                    document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
                    
                    if (document.querySelector('.tab.active').getAttribute('data-tab') === 'search') {
                        loadAllData();
                    }
                } else {
                    showAlert(`❌ Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showAlert(`❌ Error de conexión: ${error.message}`, 'error');
            } finally {
                showSpinner(false);
            }
        }
        
        // Cargar todos los datos
        async function loadAllData() {
            if (!SCRIPT_URL) {
                showAlert('Configura la URL primero', 'error');
                switchTab('config');
                return;
            }
            
            showSpinner(true);
            
            try {
                const url = `${SCRIPT_URL}?action=getAll`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.result === 'success' && result.data) {
                    allData = result.data;
                    filteredData = [...allData];
                    sortData();
                    displayData(filteredData);
                } else {
                    showAlert(`❌ Error del servidor: ${result.error || 'Sin datos'}`, 'error');
                    allData = [];
                    filteredData = [];
                    displayData([]);
                }
            } catch (error) {
                showAlert(`❌ Error al cargar datos: ${error.message}`, 'error');
                allData = [];
                filteredData = [];
                displayData([]);
            } finally {
                showSpinner(false);
            }
        }
        
        // Mostrar todos los datos (sin filtros)
        function showAllData() {
            if (allData.length === 0) {
                showAlert('Primero carga los datos', 'info');
                loadAllData();
                return;
            }
            
            filteredData = [...allData];
            clearAllFilters();
            sortData();
            displayData(filteredData);
        }
        
        // Búsqueda general
        async function searchGeneral() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            if (!searchTerm) {
                showAlert('Ingresa un término de búsqueda', 'error');
                return;
            }
            
            showSpinner(true);
            
            try {
                const url = `${SCRIPT_URL}?action=search&term=${encodeURIComponent(searchTerm)}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.result === 'success' && result.data) {
                    allData = result.data;
                    filteredData = [...allData];
                    sortData();
                    displayData(filteredData);
                } else {
                    showAlert(`❌ No se encontraron resultados para "${searchTerm}"`, 'error');
                    allData = [];
                    filteredData = [];
                    displayData([]);
                }
            } catch (error) {
                showAlert(`❌ Error de búsqueda: ${error.message}`, 'error');
                displayData([]);
            } finally {
                showSpinner(false);
            }
        }
        
        // Aplicar filtros
        function applyFilters() {
            console.log('Aplicando filtros...');
            
            if (allData.length === 0) {
                showAlert('Primero carga los datos usando "Ver Todos"', 'info');
                return;
            }
            
            // Obtener valores de los filtros
            const matricula = document.getElementById('filterMatricula').value.trim().toUpperCase();
            const marca = document.getElementById('filterMarca').value.trim().toLowerCase();
            const codigo = document.getElementById('filterCodigo').value.trim().toUpperCase();
            const fechaDesde = document.getElementById('filterFechaDesde').value;
            const fechaHasta = document.getElementById('filterFechaHasta').value;
            
            console.log('Filtros:', { matricula, marca, codigo, fechaDesde, fechaHasta });
            
            // Aplicar filtros
            filteredData = allData.filter(item => {
                // Filtro por matrícula
                if (matricula) {
                    const itemMatricula = item.Matrícula || item['Matrícula'] || '';
                    if (!itemMatricula.toUpperCase().includes(matricula)) {
                        return false;
                    }
                }
                
                // Filtro por marca
                if (marca) {
                    const itemMarca = item.Marca || '';
                    if (!itemMarca.toLowerCase().includes(marca)) {
                        return false;
                    }
                }
                
                // Filtro por código
                if (codigo) {
                    const itemCodigo = item['Código de avería'] || '';
                    if (!itemCodigo.toUpperCase().includes(codigo)) {
                        return false;
                    }
                }
                
                // Filtro por fecha
                if (fechaDesde || fechaHasta) {
                    const itemFecha = item.Fecha ? new Date(item.Fecha) : null;
                    
                    if (fechaDesde && itemFecha) {
                        const desde = new Date(fechaDesde);
                        if (itemFecha < desde) return false;
                    }
                    
                    if (fechaHasta && itemFecha) {
                        const hasta = new Date(fechaHasta);
                        hasta.setHours(23, 59, 59, 999);
                        if (itemFecha > hasta) return false;
                    }
                }
                
                return true;
            });
            
            console.log('Resultados filtrados:', filteredData.length);
            
            // Ordenar y mostrar
            sortData();
            displayData(filteredData);
        }
        
        // Limpiar todos los filtros
        function clearAllFilters() {
            document.getElementById('filterMatricula').value = '';
            document.getElementById('filterMarca').value = '';
            document.getElementById('filterCodigo').value = '';
            
            const today = new Date().toISOString().split('T')[0];
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            
            document.getElementById('filterFechaDesde').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('filterFechaHasta').value = today;
            
            document.getElementById('searchInput').value = '';
            
            filteredData = [...allData];
        }
        
        // Ordenar datos
        function sortData() {
            if (filteredData.length === 0) return;
            
            const sortBy = document.getElementById('sortSelect').value;
            
            filteredData.sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc':
                        const dateA = a.Fecha ? new Date(a.Fecha) : new Date(0);
                        const dateB = b.Fecha ? new Date(b.Fecha) : new Date(0);
                        return dateB - dateA;
                        
                    case 'date-asc':
                        const dateA2 = a.Fecha ? new Date(a.Fecha) : new Date(0);
                        const dateB2 = b.Fecha ? new Date(b.Fecha) : new Date(0);
                        return dateA2 - dateB2;
                        
                    case 'matricula-asc':
                        const matriculaA = a.Matrícula || a['Matrícula'] || '';
                        const matriculaB = b.Matrícula || b['Matrícula'] || '';
                        return matriculaA.localeCompare(matriculaB);
                        
                    case 'matricula-desc':
                        const matriculaA2 = a.Matrícula || a['Matrícula'] || '';
                        const matriculaB2 = b.Matrícula || b['Matrícula'] || '';
                        return matriculaB2.localeCompare(matriculaA2);
                        
                    case 'marca-asc':
                        const marcaA = a.Marca || '';
                        const marcaB = b.Marca || '';
                        return marcaA.localeCompare(marcaB);
                        
                    default:
                        return 0;
                }
            });
            
            displayData(filteredData);
        }
        
        // FILTROS RÁPIDOS
        
        function filterToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterFechaDesde').value = today;
            document.getElementById('filterFechaHasta').value = today;
            applyFilters();
        }
        
        function filterThisWeek() {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            
            document.getElementById('filterFechaDesde').value = startOfWeek.toISOString().split('T')[0];
            document.getElementById('filterFechaHasta').value = today.toISOString().split('T')[0];
            applyFilters();
        }
        
        function filterThisMonth() {
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('filterFechaDesde').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('filterFechaHasta').value = today.toISOString().split('T')[0];
            applyFilters();
        }
        
        function filterByMatriculaPrompt() {
            const matricula = prompt("Introduce la matrícula a filtrar:");
            if (matricula) {
                document.getElementById('filterMatricula').value = matricula.toUpperCase();
                applyFilters();
            }
        }
        
        function filterWithCode() {
            document.getElementById('filterCodigo').value = '';
            filteredData = allData.filter(item => {
                const codigo = item['Código de avería'] || '';
                return codigo && codigo.trim() !== '';
            });
            sortData();
            displayData(filteredData);
        }
        
        function filterWithoutCode() {
            document.getElementById('filterCodigo').value = '';
            filteredData = allData.filter(item => {
                const codigo = item['Código de avería'] || '';
                return !codigo || codigo.trim() === '';
            });
            sortData();
            displayData(filteredData);
        }
        
        // Exportar a Excel
        function exportToExcel() {
            if (filteredData.length === 0) {
                showAlert('No hay datos para exportar', 'error');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            const headers = ['Fecha', 'Matrícula', 'Código de avería', 'Marca', 'Modelo', 'Síntomas', 'Avería real', 'Procedimiento'];
            csvContent += headers.join(",") + "\n";
            
            filteredData.forEach(item => {
                const row = [
                    `"${item.Fecha || ''}"`,
                    `"${item.Matrícula || item['Matrícula'] || ''}"`,
                    `"${item['Código de avería'] || ''}"`,
                    `"${item.Marca || ''}"`,
                    `"${item.Modelo || ''}"`,
                    `"${(item.Síntomas || item.Sintomas || '').replace(/"/g, '""')}"`,
                    `"${(item['Avería real'] || item['Averia real'] || item.Avería || '').replace(/"/g, '""')}"`,
                    `"${(item.Procedimiento || '').replace(/"/g, '""')}"`
                ];
                csvContent += row.join(",") + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `averias_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            
            link.click();
            document.body.removeChild(link);
            
            showAlert(`✅ Exportados ${filteredData.length} registros a CSV`, 'success');
        }
        
        // Mostrar datos
        function displayData(data) {
            const dataList = document.getElementById('dataList');
            const resultsCount = document.getElementById('resultsCount');
            
            if (!Array.isArray(data)) {
                data = [];
            }
            
            if (!data || data.length === 0) {
                dataList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-database" style="font-size: 3rem; color: #ddd; display: block; text-align: center; margin: 40px 0 20px;"></i>
                        <h3 style="text-align: center; color: #666;">No se encontraron registros</h3>
                        <p style="text-align: center; color: #888;">Ajusta los filtros e intenta de nuevo</p>
                    </div>
                `;
                resultsCount.textContent = '0 registros encontrados';
                return;
            }
            
            resultsCount.textContent = `${data.length} registro(s) encontrado(s)`;
            
            let html = '';
            
            data.forEach(item => {
                item = item || {};
                
                const fecha = item.Fecha ? 
                    new Date(item.Fecha).toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Fecha no disponible';
                
                const matricula = item.Matrícula || item['Matrícula'] || 'SIN MATRÍCULA';
                const marca = item.Marca || 'No especificada';
                const modelo = item.Modelo || 'No especificado';
                const codigo = item['Código de avería'] || item['Código'] || '';
                const sintomas = item.Síntomas || item.Sintomas || 'No especificados';
                const averiaReal = item['Avería real'] || item['Averia real'] || item.Avería || 'No especificada';
                const procedimiento = item.Procedimiento || 'No especificado';
                
                html += `
                    <div class="data-item">
                        <div class="data-header">
                            <div class="data-matricula">${matricula}</div>
                            <div class="data-date">${fecha}</div>
                        </div>
                        
                        <div class="data-content">
                            <div class="data-field">
                                <span class="data-label"><i class="fas fa-industry"></i> Marca</span>
                                <span class="data-value">${marca}</span>
                            </div>
                            
                            <div class="data-field">
                                <span class="data-label"><i class="fas fa-car-side"></i> Modelo</span>
                                <span class="data-value">${modelo}</span>
                            </div>
                            
                            ${codigo ? `
                            <div class="data-field">
                                <span class="data-label"><i class="fas fa-barcode"></i> Código</span>
                                <span class="codigo-averia">${codigo}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="data-details">
                            <div class="detail-section">
                                <strong><i class="fas fa-stethoscope"></i> Síntomas Reportados</strong>
                                <p>${sintomas}</p>
                            </div>
                            
                            <div class="detail-section">
                                <strong><i class="fas fa-search"></i> Avería Real Diagnosticada</strong>
                                <p>${averiaReal}</p>
                            </div>
                            
                            <div class="detail-section">
                                <strong><i class="fas fa-tools"></i> Procedimiento Realizado</strong>
                                <p>${procedimiento}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            dataList.innerHTML = html;
        }
    </script>
</body>
</html>
